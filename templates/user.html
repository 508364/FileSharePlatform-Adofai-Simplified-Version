<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户主页 - 文件共享平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='icons/font/bootstrap-icons.min.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="pt-5">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/user">
                <i class="bi bi-cloud-arrow-up-fill me-2"></i>
                文件共享平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="refreshFiles">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </a>
                    </li>
                    <li class="nav-item">
                        <div class="user-info">
                            {% if qq %}
                                <img src="https://q1.qlogo.cn/g?b=qq&nk={{ qq }}&s=40" alt="用户头像" class="user-avatar rounded-circle" id="user-avatar" width="40" height="40">
                            {% else %}
                                <div class="user-avatar" id="user-avatar">{{ username[0]|upper }}</div>
                            {% endif %}
                            <span id="username-display" class="username-text">{{ username }}</span>
                            <button id="logout-btn" class="btn btn-outline-light logout-btn">
                                <i class="bi bi-box-arrow-right"></i> 退出
                            </button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 左侧边栏 -->
            <div class="col-lg-2 col-md-3 sidebar">
                <!-- 存储空间卡片 -->
                <div class="storage-card">
                    <div class="d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h5 class="mb-1"><i class="bi bi-hdd me-2"></i>存储空间</h5>
                                <small class="opacity-75">已使用 <span id="disk-used">{{ used_space }}</span> / <span id="max-storage">{{ total_space }}</span></small>
                            </div>
                            <div class="text-end">
                                <h2 class="mb-0" id="usage-percent">{{ usage_percent }}%</h2>
                                <small class="opacity-75">使用率</small>
                            </div>
                        </div>
                        <div class="progress-container mt-3 w-full">
                            <div class="progress-bar" id="storage-progress" style="width: {{ usage_percent }}%"></div>
                        </div>
                    </div>
                </div>

                <!-- 侧边栏菜单 -->
                <div class="sidebar-menu mt-4">
                    <h6 class="sidebar-title">功能菜单</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#platform-files" id="platform-files-link">
                                <i class="bi bi-server me-2"></i> 平台文件
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#my-files" id="my-files-link">
                                <i class="bi bi-folder2-open me-2"></i> 我的文件
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#upload-files" id="upload-files-link">
                                <i class="bi bi-cloud-upload me-2"></i> 上传文件
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#my-account" id="my-account-link">
                                <i class="bi bi-person me-2"></i> 我的账户
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="col-lg-10 col-md-9 content-area">
                <!-- 平台文件内容 -->
                <div id="platform-files" class="content-section active">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="bi bi-server me-2"></i>平台文件</h5>
                        <div class="d-flex align-items-center">
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="搜索文件" id="search-input">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 存储空间卡片（置顶显示） -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h5 class="mb-1"><i class="bi bi-hdd me-2"></i>存储空间</h5>
                                    <small class="text-muted">已使用 <span id="disk-used-platform">{{ used_space }}</span> / <span id="max-storage-platform">{{ total_space }}</span></small>
                                </div>
                                <div class="text-end">
                                    <h2 class="mb-0" id="usage-percent-platform" style="font-size: 1.5rem;">{{ usage_percent }}%</h2>
                                    <small class="text-muted">使用率</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" id="storage-progress-platform" style="width: {{ usage_percent }}%" role="progressbar" aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="file-list" class="row g-4">
                        <!-- 动态加载文件卡片 -->
                        <div class="col-12 text-center py-5" id="loading-files">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载文件列表...</p>
                        </div>
                        <div class="col-12 text-center py-5 d-none" id="no-files">
                            <i class="bi bi-file-earmark-x display-4 text-muted mb-3"></i>
                            <p>暂无文件，请上传文件</p>
                        </div>
                    </div>
                </div>

                <!-- 我的文件内容 -->
                <div id="my-files" class="content-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="bi bi-folder2-open me-2"></i>我的文件</h5>
                        <div class="d-flex align-items-center">
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="搜索我的文件" id="my-files-search-input">
                                <button class="btn btn-outline-secondary" type="button" id="my-files-search-btn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 存储空间卡片（置顶显示） -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h5 class="mb-1"><i class="bi bi-hdd me-2"></i>存储空间</h5>
                                    <small class="text-muted">已使用 <span id="disk-used-myfiles">{{ used_space }}</span> / <span id="max-storage-myfiles">{{ total_space }}</span></small>
                                </div>
                                <div class="text-end">
                                    <h2 class="mb-0" id="usage-percent-myfiles" style="font-size: 1.5rem;">{{ usage_percent }}%</h2>
                                    <small class="text-muted">使用率</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" id="storage-progress-myfiles" style="width: {{ usage_percent }}%" role="progressbar" aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="my-files-list" class="row g-4">
                        <!-- 动态加载我的文件卡片 -->
                        <div class="col-12 text-center py-5" id="my-files-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载我的文件列表...</p>
                        </div>
                        <div class="col-12 text-center py-5 d-none" id="my-files-empty">
                            <i class="bi bi-file-earmark-x display-4 text-muted mb-3"></i>
                            <p>暂无文件，请上传文件</p>
                        </div>
                    </div>
                </div>

                <!-- 上传文件内容 -->
                <div id="upload-files" class="content-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="bi bi-cloud-upload me-2"></i>上传文件</h5>
                    </div>
                    
                    <!-- 存储空间卡片（置顶显示） -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h5 class="mb-1"><i class="bi bi-hdd me-2"></i>存储空间</h5>
                                    <small class="text-muted">已使用 <span id="disk-used-main">{{ used_space }}</span> / <span id="max-storage-main">{{ total_space }}</span></small>
                                </div>
                                <div class="text-end">
                                    <h2 class="mb-0" id="usage-percent-main" style="font-size: 1.5rem;">{{ usage_percent }}%</h2>
                                    <small class="text-muted">使用率</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" id="storage-progress-main" style="width: {{ usage_percent }}%" role="progressbar" aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传区域 -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0"><i class="bi bi-cloud-upload me-2"></i>上传文件</h5>
                                <span class="badge bg-primary" id="max-file-size">最大可以上传{{ max_file_size }}MB</span>
                            </div>
                            
                            <div class="border rounded p-5 text-center mb-3" id="drop-area">
                                <div id="upload-content">
                                    <i class="bi bi-cloud-arrow-up display-4 text-muted mb-3"></i>
                                    <h6>拖放文件到此处上传</h6>
                                    <p class="text-muted small">或点击选择文件（仅支持单文件上传）</p>
                                    <input type="file" id="file-input" class="d-none">
                                    <button class="btn btn-primary px-4" id="browse-btn">浏览文件</button>
                                </div>
                                <div id="upload-progress" class="d-none">
                                    <h5 class="mb-3" id="upload-filename">上传中...</h5>
                                    <div class="progress mt-2">
                                        <div class="progress-bar" id="upload-progress-bar" style="width: 0%"></div>
                                    </div>
                                    <div class="mt-2" id="upload-stats">0% • 0 KB/s • 0s 剩余</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 我的账户内容 -->
                <div id="my-account" class="content-section d-none">
                    <div class="mb-3">
                        <h5><i class="bi bi-person me-2"></i>我的账户</h5>
                    </div>
                    
                    <!-- 顶部用户信息卡片 -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar-large">
                                    {% if qq %}
                                        <img src="https://q1.qlogo.cn/g?b=qq&nk={{ qq }}&s=100" alt="用户头像" class="rounded-circle" width="80" height="80">
                                    {% else %}
                                        <div class="user-avatar" style="width: 80px; height: 80px; font-size: 32px;">{{ username[0]|upper }}</div>
                                    {% endif %}
                                </div>
                                <div class="ms-4 flex-grow-1">
                                    <h3 class="mb-1">{{ username }}</h3>
                                    <p class="text-muted mb-2">
                                        {% if qq %}
                                            <i class="bi bi-qq me-1"></i> QQ: {{ qq }}
                                        {% else %}
                                            <i class="bi bi-qq me-1"></i> 未绑定QQ
                                        {% endif %}
                                    </p>
                                    <div class="d-flex gap-2 mb-3">
                                        <button class="btn btn-outline-primary btn-sm" id="edit-profile-btn"><i class="bi bi-pencil me-1"></i> 编辑资料</button>
                                        <button class="btn btn-outline-secondary btn-sm" id="change-password-btn"><i class="bi bi-shield-lock me-1"></i> 修改密码</button>
                                    </div>
                                    <!-- Token信息 -->
                                    <div class="token-info p-2 bg-info bg-opacity-10 rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">Token剩余有效期</small>
                                                <div id="token-expiry" class="fw-medium"></div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">当前Token</small>
                                                <div id="current-token" class="fw-medium text-truncate" style="max-width: 200px; cursor: pointer;" title="点击复制Token"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    账户信息
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">用户名</label>
                                        <input type="text" class="form-control" value="{{ username }}" readonly>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">QQ号</label>
                                        <input type="text" class="form-control" value="{{ qq or '-' }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">账户类型</label>
                                        <input type="text" class="form-control" value="{% if username == '游客' %}游客{% else %}注册用户{% endif %}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    上传统计
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">总上传文件数</label>
                                        <input type="text" class="form-control" value="{{ total_uploads }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">总上传大小</label>
                                        <input type="text" class="form-control" value="{{ total_upload_size }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">最近上传</label>
                                        <input type="text" class="form-control" value="{{ last_upload_time }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="theme-switch-container">
        <button id="theme-toggle" class="btn btn-sm">
            <i class="bi bi-moon"></i>
        </button>
    </div>

    <!-- 退出登录确认弹窗 -->
    <div class="modal fade" id="logout-modal" tabindex="-1" aria-labelledby="logout-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
                <div class="modal-header">
                    <h5 class="modal-title" id="logout-modal-label">退出登录确认</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要退出登录吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-logout">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑资料弹窗 -->
    <div class="modal fade" id="edit-profile-modal" tabindex="-1" aria-labelledby="edit-profile-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit-profile-modal-label">编辑资料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-profile-form">
                        <div class="mb-3">
                            <label for="edit-username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="edit-username" value="{{ username }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-qq" class="form-label">QQ号</label>
                            <input type="text" class="form-control" id="edit-qq" placeholder="请输入QQ号" value="{{ qq or '' }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-profile-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码弹窗 -->
    <div class="modal fade" id="change-password-modal" tabindex="-1" aria-labelledby="change-password-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
                <div class="modal-header">
                    <h5 class="modal-title" id="change-password-modal-label">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="current-password" placeholder="请输入当前密码" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="new-password" placeholder="请输入新密码" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-new-password" class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirm-new-password" placeholder="请再次输入新密码" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-password-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化user页面功能
            initUserPage({
                username: '{{ username }}',
                loginTime: '{{ login_time }}',
                totalUploads: '{{ total_uploads }}',
                totalUploadSize: '{{ total_upload_size }}',
                lastUploadTime: '{{ last_upload_time }}'
            });

            // 获取按钮元素
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const savePasswordBtn = document.getElementById('save-password-btn');
            const logoutBtn = document.getElementById('logout-btn');

            // 获取模态框元素
            const editProfileModal = new bootstrap.Modal(document.getElementById('edit-profile-modal'));
            const changePasswordModal = new bootstrap.Modal(document.getElementById('change-password-modal'));

            // 编辑资料按钮点击事件
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function() {
                    editProfileModal.show();
                });
            }

            // 修改密码按钮点击事件
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', function() {
                    changePasswordModal.show();
                });
            }

            // 保存资料按钮点击事件
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', function() {
                    // 这里可以添加保存逻辑
                    const qqInput = document.getElementById('edit-qq');
                    const newQQ = qqInput.value;
                    
                    // 简单验证
                    if (newQQ && !/^\d{5,11}$/.test(newQQ)) {
                        alert('请输入有效的QQ号（5-11位数字）');
                        return;
                    }
                    
                    // 显示保存成功消息
                    alert('资料保存成功！\n\n注意：QQ号修改需要管理员在后台进行操作，此功能暂未完全实现。');
                    editProfileModal.hide();
                });
            }

            // 保存密码按钮点击事件
            if (savePasswordBtn) {
                savePasswordBtn.addEventListener('click', function() {
                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmNewPassword = document.getElementById('confirm-new-password').value;
                    
                    // 简单验证
                    if (!currentPassword || !newPassword || !confirmNewPassword) {
                        alert('请填写所有密码字段');
                        return;
                    }
                    
                    if (newPassword !== confirmNewPassword) {
                        alert('两次输入的新密码不一致');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        alert('新密码长度不能少于6位');
                        return;
                    }
                    
                    // 显示保存成功消息
                    alert('密码修改成功！\n\n注意：此功能暂未完全实现，实际修改需要通过管理员操作。');
                    changePasswordModal.hide();
                });
            }

            // 登出按钮点击事件
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    // 清除token
                    localStorage.removeItem('auth_token');
                    sessionStorage.removeItem('auth_token');
                    localStorage.removeItem('username');
                    sessionStorage.removeItem('username');
                    console.log('token已清除');
                });
            }

            // 为所有fetch请求添加token
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                // 获取token
                const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                
                // 添加token到请求头
                if (token) {
                    options.headers = options.headers || {};
                    if (typeof options.headers === 'object' && !options.headers.Authorization) {
                        options.headers.Authorization = `Bearer ${token}`;
                    }
                }
                
                return originalFetch.call(this, url, options);
            };
        });
    </script>
</body>
</html>